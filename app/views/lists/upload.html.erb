<div class="row">
  <div class="col-lg-12">
     <h1 class="page-header">
       Import Contacts Lists
       <div class="pull-right">
        <%= link_to 'Add to List',  import_map_list_path(@list), class: 'btn btn-default import-data' %>
        </div>
     </h1>
  </div>
</div>
<div class="row">
  <div class="col-lg-12">
    <div class="panel panel-default">
      <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover" id="dataTable">
          <thead>
            <tr role="row">
            <% @temp_contacts[0].content.each_with_index do |c, i| %>
              <th>
                <span id="f_newcol-<%= i %>">
                  <div class="form-group">
                    <label>New Column Name</label>
                    <%= form_for [@list, ColumnList.new] , format: :json ,remote: true , html: {'data-id' => i}  do |f| %>
                      <input id="newcol-<%= i %>" class="form-control" value="" maxlength="50" type="text" name="column_list[name]">
                      <input id="submit-newcol-<%= i %>" class="btn btn-default" name="submit-newcol-<%= i%>" type="submit" value="Save">
                      <input id="discard-newcol-<%= i %>" class="btn btn-default" name="discard-newcol-<%= i%>" data-id="<%= i %>" type="button" value="Discard">
                    <% end %>
                  </div>
                </span>
                <div class="form-group">
                <select id="sel_col_<%= i %>" class="form-control" data-id="<%= i %>" >
                  <option value="0" selected="selected">Select option</option>
                  <option value="new">New column</option>
                  <optgroup label="Available Column Names">
                  <% @list.column_list.each do |col| %>
                  <option value="<%= col.id %>"><%= col.name %></option>
                  <% end %>
                  </optgroup>
                </select>
                </div>
              </th>
            <% end %>
            </tr>
          </thead>

          <tbody>
            <tr class="odd gradeX">
            <% @temp_contacts.each do |tmp| %>
              <% tmp.content.each do |col| %>
                <td><%= col %></td>
              <% end %>
            </tr>
            <% end %>
         </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  var columns_map = [];
  var key = '<%= @key %>';
  var key_map = <%= @list.column_list.key_map.id %>;
  $('select[id^="sel_col"]').on('change', function (e) {
    var value = $(this).val();
    var id = $(this).data('id');
     if (value == 'new') {
      $("span[id=f_newcol-" + id + "]").show();
      $("#newcol-" + id ).focus()
     }else{
      $("span[id=f_newcol-" + id + "]").hide();
      $("select[id^=sel_col] option[value=" + value + "]").attr('disabled','disabled')
      addColumn(id, value);
      $(this).find('option:selected').removeAttr('disabled');
     }
   });

  $('input[name^="discard-newcol"]').on('click', function() {
    var id = $(this).data('id');
    $("span[id=f_newcol-" + id + "]").hide();
    $('#sel_col_' + id ).val(0)
  });

  $('.new_column_list').bind('ajax:success', function(data, status, xhr){
    var id = $(this).data('id');
    var option = new Option(status.name, status.id);
    $("select[id^=sel_col] optgroup").append(option);
    $("span[id=f_newcol-" + id + "]").hide();
    $("select[id^=sel_col] option[value=" + status.id + "]").attr('disabled','disabled');
    $('#sel_col_' + id ).val(status.id)
    addColumn(id, status.id);
    $(this).find('option:selected').removeAttr('disabled');  
  });

  $("span[id*=f_newcol]").hide();
  $('.import-data').addClass('disabled');

  function addColumn(id, column) {
    var value = parseInt(column);
    columns_map[id] = value;

    var enable = false;
    $.each(columns_map,  function( index, value ) {
      if (key_map == value) {
        enable = true;
      }
    });

    if (enable) {
      $('.import-data').removeClass('disabled');
    }else{
      $('.import-data').addClass('disabled');
    }
  }

</script>
